---
layout: post
title: (개발/DB) 한달 차 신입의 착각
description: 테스트
header: (개발/DB) 한달 차 신입의 착각
duration: 7 minutes read
ogimage: "img/favicon.png"
published: true
date: 2024-05-12
---

### 한달 차 신입의 착각

결론부터 이야기하자면 한 달 정도 보고 실무에서 서버, DB의 구조를 어느정도 파악했다는 착각을 하고 있었습니다.
거기에 나름 처음으로 크게 해본 업무인 DB 간 copy업무를 잘 해냈다고 생각했지만 이것 역시 착각이었습니다.

우선 기능 개발을 하면서 DB간의 데이터를 복사해야할 필요가 있었습니다.
저는 단순히 복사해야할 데이터가 있는 A 서버의 테이블을 B 서버에 옮긴다는 생각 뿐이었습니다.
그래서 B 서버에서 A 서버로 Mybatis를 이용해 ResultSet으로 테이블의 모든 데이터를 가져온 뒤 List로 변환하고, 
List.equals()를 이용해 데이터가 변할 때만 upsert 방식을 이용해서 데이터를 복사하는 방식을 정했습니다.

근거는 당장은 성능에 크게 영향을 주는 부분밖에 떠올리지 못했고, get 요청은 단순한 read 이기 때문에 트랜잭션 readOnly를 적용해서
lock을 줄여 충돌이나 대기 시간을 줄이는 방식으로 서비스 코드를 작성해서 나름대로 성능에 영향을 가장 적게 주는 방법을 택했습니다.
그리고 upsert라는 방식도 처음 써봤는데 insert + update를 동시에 해주는 훌륭한 쿼리입니다. 
이 방식을 데이터의 변경을 감지하고, 데이터가 변경될 때만 사용하게 해서 데이터 쓰기상황 자체를 줄여 성능을 고려해봤습니다.
물론 이렇게 하면 B 서버가 A 서버에 의존한다는 사실도 알고 있었지만, 쿼리를 이용해서 가져오는 방식밖에 떠올리지 못했기 때문에 
A 서버에서 B 서버에 데이터를 보내주는 방식 자체는 제 수준에서는 불가능하다고 생각했습니다. 
순전히 DB 간의 복사는 느리기도 하고, 추적이 힘들다는 피드백을 받았기 때문에 제외했습니다.
그래서 위에 방식이 제가 생각하기에는 최선의 선택지였다고 생각했습니다.

그런데 아니었습니다. 물론 제가 가지고 있는 지식 수준에서는 최선이었을지는 몰라도
당장 제가 고려하지 못했던 개념들이 상당히 많았습니다. 
제가 진행했던 방식이 poll 방식인지, pull 방식인지도 몰랐고 DB replication 이라는 방식도 아예 몰랐습니다.
그리고 shared storage, redis나 kafka를 적용하는 방식도 있었습니다. 역시 몰랐습니다.
이런 방식들을 모르니 아예 떠올리지도 못했고, 당장 문제 없이 정상적으로 동작하는 것만으로도 만족하고 있었습니다.

제가 한 방식은 데이터 서버간에 pulling 방식 (서버의 데이터를 주기적으로 가져가는 방식) 이었고,
웹 서버에서는 B서버에서 A서버가 아닌 B서버에서 B서버 자체 DB에 polling 방식(서버 데이터를 주기적으로 요청하는 방식) get으로 요청만 가져갑니다.
저는 이 개념을 모르고 최선을 다했다고 착각하고 있었습니다. 그래도 이미 데이터 서버간 pulling 구조로 짜여있던 회사 코드 덕분에 팀킬 상황을 면할 수 있었네요.
이번엔 잘 짜여있는 구조 위에서 개발했기 때문에 운이 좋았다고 생각합니다. 그리고 이제야 DB구조를 파악할 수 있었네요.

제가 한 방식보다 더 괜찮은 방식이 kafka같은 플랫폼을 이용하는 방식입니다.
B 서버는 shared storage를 데이터를 보내고 A 서버는 구독하기만 하면 되기 때문입니다.
장점은 영속성이 있기 때문에 요청을 잃어버릴 이유도 없고 토픽 내에서 데이터를 여러 브로커에 복제하기 때문에 데이터 손실도 방지합니다.
단점이 있다면 kafka를 도입해야되고 누가 관리할 것이고 데이터 관리를 어떻게 할지에 대한 고민을 해야된다는 점입니다. 
당연히 사용해보면 좋겠지만 한달 차 신입이 제안하는건 눈치가 보이네요...

또 DB replication 이란 방식으로 master db와 slave db를 두고 애플리케이션 서버에서는 master db에 쓰기만 하고 slave db에서 읽기만 하는
방식이 있었습니다. 이런건 있는지도 몰랐네요 쿼리의 대부분을 데이터 읽기가 차지하는 경우 사용하면 되는데
저같은 경우엔 제가 맡은 기능은 B서버에서 단순히 읽기만 하면 되기 때문에 이 방식을 고려해볼 수 있었습니다.
읽기의 성능을 올려주는 방식이고, db 시스템이 두개라서 데이터가 백업되는 장점까지 있습니다.
단점은 slave가 master의 복사본을 사용하기 때문에 정합성 문제가 있을 수 있고, 관리가 힘들 수 있습니다.

아무튼 이렇게 단순히 코드로만 해결하는게 아니라 더 나은 플랫폼이나 DB replication 같은 방식으로 해결하는 방법도 있다는걸 경험했습니다.
개발은 정말 깊이를 알 수 없네요 물론 경우의 수가 너무 많은 개발에 정답은 없겠지만 아직 갈길이 멀다고 느꼈습니다.
지금처럼 당장의 지식수준에서 구현하고 실제로 단점을 겪으면서 이런 것들이 있구나 알아내면서 실력이 느는 것도 좋겠지만,
미리 조금 더 알아보고 처음부터 이런 상위 개념의 방식으로 구현을 하는게 더 나아보이네요.


